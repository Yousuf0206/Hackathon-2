name: Deploy to Minikube (Local)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy"
        required: false
        default: "latest"

jobs:
  deploy-local:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          kubernetes-version: v1.28.0

      - name: Install Dapr CLI
        run: |
          wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash
          dapr init -k --wait

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Build local images
        run: |
          eval $(minikube docker-env)
          docker build -t todo-chat-api:latest services/chat-api/
          docker build -t todo-notification:latest services/notification/
          docker build -t todo-recurring-task:latest services/recurring-task/
          docker build -t todo-audit:latest services/audit/
          docker build -t todo-websocket:latest services/websocket/
          docker build -t todo-frontend:latest frontend/

      - name: Apply Dapr components
        run: kubectl apply -f dapr/components/

      - name: Apply Dapr subscriptions
        run: kubectl apply -f dapr/components/subscriptions/

      - name: Deploy with Helm
        run: |
          helm dependency update helm/todo-app
          helm upgrade --install todo-app helm/todo-app \
            -f helm/todo-app/values-local.yaml \
            --wait --timeout 5m

      - name: Smoke test - Health checks
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=chat-api --timeout=120s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=audit --timeout=120s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=frontend --timeout=120s

          CHAT_API_POD=$(kubectl get pod -l app.kubernetes.io/component=chat-api -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $CHAT_API_POD -c chat-api -- curl -sf http://localhost:8000/health

          AUDIT_POD=$(kubectl get pod -l app.kubernetes.io/component=audit -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $AUDIT_POD -c audit -- curl -sf http://localhost:8003/health
